<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LLM Diagram</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        .tocDiagram svg {
            /* flex: 1; */
            /* background-color: rgba(255, 0, 0, 0.1); */
        }
        .tocTitle {
            font-size: 1.1rem;
            text-align: center;
            margin: 10px 0 4px;
        }
        .tocGroupTitle {
            font-size: 0.8rem;
            opacity: 0.8;
            padding: 4px 0 0;
            border-bottom: 1px solid #ccc;
            margin-bottom: 4px;
        }
        .menuEntry {
            cursor: pointer;
            padding: 4px 4px 4px 12px;
        }
        .menuEntry.active {
            background-color: lightblue;
        }
        .menuEntry.hover {
            background-color: #338;
            color: white;
        }
        .dataPath {
            stroke-width: 1.5;
            stroke: rgba(0, 0, 0, 0.8);
            fill: none;
        }
        .gap {
            stroke-width: 1.5;
            stroke: rgba(0, 0, 0, 0.8);
            fill: none;
        }
        .active {
            opacity: 1;
        }
    </style>
	<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
<div class="container">
    <div class="row">
        <div class="col-auto">
            <div class="tocDiagram" id="interactive-svg">
                <svg viewBox="0 0 310 512.5" width="310px" height="512.5">
                    <g transform="translate(50.625 20)">
                        <rect x="0" y="0" width="33.109375" height="20" fill="rgba(107,64,216,.3)"></rect>
                        <text x="0" y="16" font-size="14">How</text>
                        <text x="16.0546875" y="30" font-size="9" text-anchor="middle" fill="#338a">2437</text>
                        <rect x="32.109375" y="0" width="18.4453125" height="20" fill="rgba(104,222,122,.4)"></rect>
                        <text x="32.109375" y="16" font-size="14">&nbsp;to</text>
                        <text x="40.83203125" y="30" font-size="9" text-anchor="middle" fill="#338a">284</text>
                        <rect x="49.5546875" y="0" width="50.421875" height="20" fill="rgba(244,172,54,.4)"></rect>
                        <text x="49.5546875" y="16" font-size="14">&nbsp;predict</text>
                        <text x="74.265625" y="30" font-size="9" text-anchor="middle" fill="#338a">4331</text>
                        <rect x="98.9765625" y="-10" width="29.9921875" height="20" fill="rgba(239,65,70,.4)"></rect>
                        <text x="98.9765625" y="6" font-size="12" fill-opacity="0.8">&nbsp;text</text>
                        <text x="173.75" y="3" font-size="9" text-anchor="end" fill="#338a">2420</text>
                        <rect x="98.9765625" y="10" width="47.7734375" height="20" fill="rgba(239,65,70,.4)"></rect>
                        <text x="98.9765625" y="26" font-size="12" fill-opacity="0.5">&nbsp;tokens</text>
                        <text x="173.75" y="23" font-size="9" text-anchor="end" fill="#338a">16326</text>
                        <rect x="98.9765625" y="30" width="45.109375" height="20" fill="rgba(239,65,70,.4)"></rect>
                        <text x="98.9765625" y="46" font-size="12" fill-opacity="0.3">&nbsp;words</text>
                        <text x="173.75" y="43" font-size="9" text-anchor="end" fill="#338a">2456</text>
                        <rect x="99.9765625" y="-9" width="78.7734375" height="58" fill="none" stroke="rgba(239,65,70,.4)" stroke-dasharray="4,4"></rect>
                    </g>
                    <g transform="translate(10.5, 90.5)" opacity="1">
                        <rect width="240" height="412" fill="#eee" rx="3" ry="3" stroke-dasharray="2 2" stroke="rgb(199, 199, 199)"></rect>
                        <g transform="translate(80, 20)" opacity="0.5" class="interactive" data-description="##### Step 2: Embed the tokens\nthis is the embedding step previously discussed, where tokens are converted into embeddings">
                            <rect width="80" height="20" fill="#f0a8fc" rx="3" ry="3" stroke="rgb(201, 141, 211)" stroke-width="1"></rect>
                            <text x="40" y="15" width="80" font-size="11" text-anchor="middle">tok embed</text>
                        </g>
                        <g transform="translate(20, 40)" opacity="0.5" class="interactive" data-description="This adds on to the embeddings by encoding positional information (where the word is in the sentence). This is just a slight adjustment to the embeddings to add this information (this is very important as 'ate cat' and 'cat ate' mean very different things)">
                            <line class="gap" x1="100" x2="100" y1="0" y2="36" stroke="#000"></line>
                            <text font-size="11" text-anchor="end" x="46" y="20.75">pos embed</text>
                            <circle cx="60" cy="18" r="10" stroke="#000" fill="none"></circle>;
                            <line x1="74" x2="90" y1="18" y2="18" stroke="#000" stroke-width="1"></line>;
                            <text text-anchor="middle" x="60" y="23" font-size="18">~</text>
                            <g>
                                <path d="M87,20 L92,18 L87,16Z" fill="#000" class="dataPath"></path>
                            </g>
                            <g>
                                <circle cx="100" cy="18" r="6" stroke="#000000" fill="white"></circle>;
                                <line x1="96" y1="18" x2="104" y2="18" stroke="#000000" stroke-width="1"></line>;
                                <line x1="100" y1="14" x2="100" y2="22" stroke="#000000" stroke-width="1"></line>;</g>
                        </g>
                        <g transform="translate(20, 76)" opacity="1">
                            <rect width="200" height="226" fill="#ddd" rx="3" ry="3" stroke="rgb(185, 185, 185)"></rect>
                            <g transform="translate(100, 0)" opacity="0.5">
                                <line class="gap" x1="0" y1="0" x2="0" y2="24" stroke="black"></line>
                                <g>
                                    <path d="M-2,19 L0,24 L2,19Z" fill="#000" class="dataPath"></path>
                                </g>
                            </g>
                            <g transform="translate(60, 24)" opacity="0.5" class="interactive" data-description="This is a layer normalization step, which is a bit of a 'trick' to speed up training by scaling the inputs to the layer so no extreme values break the training.">
                                <rect width="80" height="20" fill="#e9f29e" rx="3" ry="3" stroke="rgb(195, 202, 132)" stroke-width="1"></rect>
                                <text x="40" y="15" width="80" font-size="11" text-anchor="middle">layer norm</text>
                            </g>
                            <g transform="translate(100, 44)" opacity="0.5">
                                <line class="gap" x1="0" y1="0" x2="0" y2="16" stroke="black"></line>
                                <g>
                                    <path d="M-2,11 L0,16 L2,11Z" fill="#000" class="dataPath"></path>
                                </g>
                                <path d="M0,5 L-30,5 L-30,14" stroke="black" fill="none" class="dataPath"></path>
                                <g>
                                    <path d="M-32,11 L-30,16 L-28,11Z" fill="#000" class="dataPath"></path>
                                </g>
                                <path d="M0,5 L30,5 L30,14" stroke="black" fill="none" class="dataPath"></path>
                                <g>
                                    <path d="M28,11 L30,16 L32,11Z" fill="#000" class="dataPath"></path>
                                </g>
                            </g>
                            <g transform="translate(30, 60)" opacity="0.5" class="interactive" data-description="##### Step 3: Update the token meanings\nThis is the attention step, multiple heads are used to allow the model to look at many different relationships between the words">
                                <rect width="140" height="40" fill="#f2d59e" rx="3" ry="3" stroke="rgb(202, 178, 132)" stroke-width="1"></rect>
                                <text x="70" y="15" width="140" font-size="11" text-anchor="middle">multi-head, causal</text>
                                <text x="70" y="35" width="140" font-size="11" text-anchor="middle">self-attention</text>
                            </g>
                            <g transform="translate(100, 100)" opacity="0.5">
                                <line class="gap" x1="0" y1="0" x2="0" y2="20" stroke="black"></line>
                                <g>
                                    <circle cx="0" cy="10" r="6" stroke="#000000" fill="white"></circle>;
                                    <line x1="-4" y1="10" x2="4" y2="10" stroke="#000000" stroke-width="1"></line>;
                                    <line x1="0" y1="6" x2="0" y2="14" stroke="#000000" stroke-width="1"></line>;</g>
                            </g>
                            <g transform="translate(100, 120)" opacity="0.5">
                                <line class="gap" x1="0" y1="0" x2="0" y2="16" stroke="black"></line>
                                <g>
                                    <path d="M-2,11 L0,16 L2,11Z" fill="#000" class="dataPath"></path>
                                </g>
                            </g>
                            <g transform="translate(60, 136)" opacity="0.5" class="interactive" data-description="This is a layer normalization step, which is a bit of a 'trick' to speed up training by scaling the inputs to the layer so no extreme values break the training.">
                                <rect width="80" height="20" fill="#e9f29e" rx="3" ry="3" stroke="rgb(195, 202, 132)" stroke-width="1"></rect>
                                <text x="40" y="15" width="80" font-size="11" text-anchor="middle">layer norm</text>
                            </g>
                            <g transform="translate(100, 156)" opacity="0.5">
                                <line class="gap" x1="0" y1="0" x2="0" y2="10" stroke="black"></line>
                                <g>
                                    <path d="M-2,5 L0,10 L2,5Z" fill="#000" class="dataPath"></path>
                                </g>
                            </g>
                            <g transform="translate(50, 166)" opacity="0.5" class="interactive" data-description="##### Step 4: Bake in world knowledge\nThis bakes in world knowledge into the embeddings, adding multi-token associations like what names mean">
                                <rect width="100" height="40" fill="#9ef2f2" rx="3" ry="3" stroke="rgb(132, 202, 202)" stroke-width="1"></rect>
                                <text x="50" y="15" width="100" font-size="11" text-anchor="middle">feed</text>
                                <text x="50" y="35" width="100" font-size="11" text-anchor="middle">forward</text>
                            </g>
                            <g transform="translate(100, 206)" opacity="0.5">
                                <line class="gap" x1="0" y1="0" x2="0" y2="20" stroke="black"></line>
                                <g>
                                    <circle cx="0" cy="10" r="6" stroke="#000000" fill="white"></circle>;
                                    <line x1="-4" y1="10" x2="4" y2="10" stroke="#000000" stroke-width="1"></line>;
                                    <line x1="0" y1="6" x2="0" y2="14" stroke="#000000" stroke-width="1"></line>;</g>
                            </g>
                            <path d="M100,6 L190,6 L190,110 L112,110" fill="none" stroke-linejoin="round" opacity="0.5" class="dataPath"></path>
                            <g>
                                <path d="M113,108 L108,110 L113,112Z" fill="#000" class="dataPath"></path>
                            </g>
                            <path d="M100,124 L190,124 L190,216 L112,216" fill="none" stroke-linejoin="round" opacity="0.5" class="dataPath"></path>
                            <g>
                                <path d="M113,214 L108,216 L113,218Z" fill="#000" class="dataPath"></path>
                            </g>
                            <text font-size="13" text-anchor="start" x="4" y="14" fill="#555">transformer i</text>
                        </g>
                        <g transform="translate(120, 302)" opacity="0.5">
                            <line class="gap" x1="0" y1="0" x2="0" y2="10" stroke="black"></line>
                            <g>
                                <path d="M-2,5 L0,10 L2,5Z" fill="#000" class="dataPath"></path>
                            </g>
                        </g>
                        <g transform="translate(80, 312)" opacity="0.5" class="interactive" data-description="This is a layer normalization step, which is a bit of a 'trick' to speed up training by scaling the inputs to the layer so no extreme values break the training.">
                            <rect width="80" height="20" fill="#e9f29e" rx="3" ry="3" stroke="rgb(195, 202, 132)" stroke-width="1"></rect>
                            <text x="40" y="15" width="80" font-size="11" text-anchor="middle">layer norm</text>
                        </g>
                        <g transform="translate(120, 332)" opacity="0.5">
                            <line class="gap" x1="0" y1="0" x2="0" y2="10" stroke="black"></line>
                            <g>
                                <path d="M-2,5 L0,10 L2,5Z" fill="#000" class="dataPath"></path>
                            </g>
                        </g>
                        <g transform="translate(80, 342)" opacity="0.5" class="interactive" data-description="This is the final step, where the model predicts the next word in the sequence.">
                            <rect width="80" height="20" fill="#a8c3fc" rx="3" ry="3" stroke="rgb(141, 163, 211)" stroke-width="1"></rect>
                            <text x="40" y="15" width="80" font-size="11" text-anchor="middle">linear</text>
                        </g>
                        <g transform="translate(120, 362)" opacity="0.5">
                            <line class="gap" x1="0" y1="0" x2="0" y2="10" stroke="black"></line>
                            <g>
                                <path d="M-2,5 L0,10 L2,5Z" fill="#000" class="dataPath"></path>
                            </g>
                        </g>
                        <g transform="translate(80, 372)" opacity="0.5" class="interactive" data-description="Softmax is used to convert the output of the model into a probability distribution over all possible next words">
                            <rect width="80" height="20" fill="#a8fcaf" rx="3" ry="3" stroke="rgb(141, 211, 146)" stroke-width="1"></rect>
                            <text x="40" y="15" width="80" font-size="11" text-anchor="middle">softmax</text>
                        </g>
                        <text font-size="13" text-anchor="start" x="4" y="14" fill="#333">LLM</text>
                    </g>
                    <path d="M54.625,60 L58.625,70 L141.6015625,70 L145.6015625,60M100.11328125,70 L100.11328125,100.5 L130.5,100.5 L130.5,108.5" class="dataPath"></path>
                    <g>
                        <path d="M128.5,105.5 L130.5,110.5 L132.5,105.5Z" fill="#000" class="dataPath"></path>
                    </g>
                    <path d="M130.5,482.5 L130.5,492.5 L240.5,492.5 L240.5,100.5 L188.98828125,100.5 L188.98828125,74" class="dataPath"></path>
                    <g>
                        <path d="M190.98828125,77 L188.98828125,72 L186.98828125,77Z" fill="#000" class="dataPath"></path>
                    </g>
                </svg>
            </div>
        </div>
        <div class="col">
            <div class="description-panel">
                <h3 id="description-title">Description</h3>
                <p id="description-text">Click on an element to see its description here.</p>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
    // Select the SVG and description elements
    const svg = document.getElementById('interactive-svg');
    const descriptionText = document.getElementById('description-text');
	const descriptionTitle = document.getElementById('description-title');

    var activeElem = null;
    // Add event listeners to interactive elements
    svg.querySelectorAll('.interactive').forEach(element => {
        // Handle hover
        element.addEventListener('mouseenter', () => {
			// replace '\n' with new line
            //descriptionText.innerHTML = marked.parse(element.getAttribute('data-description').replace(/\\n/g, '\n'));
            element.classList.add('active');
        });
        element.addEventListener('mouseleave', () => {
            if (activeElem === element) return;
            //descriptionText.innerHTML = 'Click on an element to see its description here.';
            element.classList.remove('active');
        });

        // Handle click
        element.addEventListener('click', () => {
            console.log('click');
            svg.querySelectorAll('.interactive').forEach(el => el.classList.remove('active'));
            element.classList.add('active');
            descriptionText.innerHTML = marked.parse(element.getAttribute('data-description').replace(/\\n/g, '\n'));
			descriptionTitle.innerHTML = element.textContent;
            activeElem = element;
        });
    });

    // Reset description on mouse leave
    svg.addEventListener('mouseleave', () => {
        //svg.querySelectorAll('.interactive').forEach(el => el.classList.remove('active'));
       // descriptionText.innerHTML = 'Hover over or click on an element to see its description here.';
    });
</script>
</body>
</html>
